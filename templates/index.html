<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concierge Chat Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add jsPDF libraries for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add chart exporter utility -->
    <script src="/static/js/chart-exporter.js"></script>
    <style>
        body {
            padding: 10px;
            background-color: #f8f9fa;
            color: #212529;
            font-size: 14px;
        }
        .header-container {
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 15px;
        }
        .card {
            margin-bottom: 15px;
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 10px;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid rgba(0,0,0,.125);
            font-weight: 600;
            padding: 0.75rem 1rem;
        }
        .card-body {
            padding: 0.75rem 1rem;
        }
        .summary-card {
            text-align: center;
            padding: 10px;
            transition: transform .2s;
        }
        .summary-card:hover {
            transform: translateY(-3px);
        }
        .summary-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: #0d6efd;
        }
        .summary-title {
            color: #6c757d;
            font-size: 0.8rem;
            margin-bottom: 3px;
        }
        .summary-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #212529;
        }
        .conversation-container {
            max-height: 450px;
            overflow-y: auto;
            background-color: #fff;
            border-radius: 10px;
        }
        .conversation-list-item {
            border-left: 5px solid transparent;
            transition: all 0.2s;
            padding: 0.5rem 0.75rem;
        }
        .conversation-list-item:hover {
            background-color: #f8f9fa;
            border-left-color: #0d6efd;
        }
        .conversation-list-item.active {
            background-color: #e9ecef;
            border-left-color: #0d6efd;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            position: relative;
            font-size: 0.9rem;
        }
        .message.user {
            background-color: #e9ecef;
            margin-left: 15%;
            border-top-right-radius: 0;
        }
        .message.concierge {
            background-color: #d1e7dd;
            margin-right: 15%;
            border-top-left-radius: 0;
        }
        .message.debug {
            background-color: #f8d7da;
            font-family: monospace;
            font-size: 0.75em;
            white-space: pre-wrap;
        }
        .message-sender {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .accuracy-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            margin-left: 8px;
        }
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
        .navbar-brand {
            font-weight: 700;
            color: #0d6efd;
        }
        .tab-content {
            background-color: #fff;
            padding: 15px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .nav-tabs {
            border-bottom: none;
        }
        .nav-tabs .nav-link {
            margin-right: 3px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            font-weight: 600;
            color: #6c757d;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }
        .nav-tabs .nav-link.active {
            border-color: #dee2e6 #dee2e6 #fff;
            background-color: #fff;
            color: #0d6efd;
        }
        .time-metric-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
        }
        .time-metric-title {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 3px;
        }
        .time-metric-value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .export-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .export-button i {
            font-size: 1.5rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 992px) {
            .summary-value {
                font-size: 1.2rem;
            }
            .chart-container {
                height: 180px;
            }
        }
        
        @media (max-width: 768px) {
            .summary-card {
                margin-bottom: 10px;
            }
            .chart-container {
                height: 160px;
            }
        }
        
        /* Print-specific styles for PDF export */
        .print-section {
            page-break-inside: avoid;
        }

        /* Additional styles for improved conversation display */
        .conversation-filter-container {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .message-timestamp {
            font-size: 0.7rem;
            color: #6c757d;
            margin-bottom: 3px;
        }
        .conversation-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .conversation-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .metric-pill {
            background-color: #e9ecef;
            border-radius: 16px;
            padding: 4px 10px;
            font-size: 0.8rem;
            color: #495057;
            display: flex;
            align-items: center;
        }
        .metric-pill i {
            margin-right: 5px;
        }
        .conversation-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        .stat-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #0d6efd;
        }
        .stat-label {
            font-size: 0.7rem;
            color: #6c757d;
        }
        .sticky-list {
            position: sticky;
            top: 0;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .restaurant-match {
            margin-bottom: 10px;
            border-radius: 8px;
            background-color: #f8f9fa;
            padding: 8px;
        }
        .restaurant-match-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .conversation-filter-row {
            margin-bottom: 10px;
        }
        /* Hide debug messages when the toggle is off */
        .hide-debug .message.debug {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="header-container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2"><i class="bi bi-chat-dots me-2"></i>Concierge Chat Analyzer</h1>
                    <p class="text-muted mb-0">Upload a WhatsApp chat export to analyze Concierge AI performance</p>
                </div>
                <div class="col-md-4 text-end">
                    <button id="export-pdf" class="btn btn-outline-primary d-none">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Export Report (PDF)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Upload Form -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-upload me-2"></i>Upload Chat File
            </div>
            <div class="card-body">
                <form id="upload-form">
                    <div class="mb-3">
                        <label for="chat-file" class="form-label">Select WhatsApp chat export file</label>
                        <input class="form-control" type="file" id="chat-file" name="chat_file">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search me-2"></i>Analyze
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading" class="text-center my-5 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Analyzing chat data...</p>
        </div>
        
        <!-- Results Container -->
        <div id="results-container" class="d-none">
            <!-- Export PDF floating button for mobile -->
            <button id="export-pdf-mobile" class="btn btn-primary export-button d-md-none">
                <i class="bi bi-file-earmark-pdf"></i>
            </button>
            
            <!-- Summary Stats -->
            <div class="card mb-4 print-section" id="summary-section">
                <div class="card-header">
                    <i class="bi bi-bar-chart-fill me-2"></i>Summary
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-card">
                                <div class="summary-icon">
                                    <i class="bi bi-chat-square-text"></i>
                                </div>
                                <div class="summary-title">TOTAL CONVERSATIONS</div>
                                <div class="summary-value" id="conversation-count">0</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-card">
                                <div class="summary-icon">
                                    <i class="bi bi-clock"></i>
                                </div>
                                <div class="summary-title">AVG. TIME TO RECOMMENDATION</div>
                                <div class="summary-value" id="avg-recommendation-time">0s</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-card">
                                <div class="summary-icon">
                                    <i class="bi bi-lightning-charge"></i>
                                </div>
                                <div class="summary-title">AVG. FIRST RESPONSE</div>
                                <div class="summary-value" id="avg-first-response">0s</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-card">
                                <div class="summary-icon">
                                    <i class="bi bi-person-check"></i>
                                </div>
                                <div class="summary-title">MATCHED PERSONAS</div>
                                <div class="summary-value" id="matched-personas">0/0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Response Time Analysis -->
            <div class="card mb-4 print-section" id="response-time-section">
                <div class="card-header">
                    <i class="bi bi-stopwatch me-2"></i>Response Time Analysis
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="chart-container">
                                <canvas id="response-time-chart"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="row">
                                <div class="col-md-6 col-lg-12">
                                    <div class="time-metric-card">
                                        <div class="time-metric-title">TIME TO FIRST RESPONSE</div>
                                        <div class="time-metric-value" id="min-first-response">Min: 0s</div>
                                        <div class="time-metric-value" id="max-first-response">Max: 0s</div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-12">
                                    <div class="time-metric-card">
                                        <div class="time-metric-title">TIME TO RECOMMENDATION</div>
                                        <div class="time-metric-value" id="min-recommendation-time">Min: 0s</div>
                                        <div class="time-metric-value" id="max-recommendation-time">Max: 0s</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Tabs -->
            <ul class="nav nav-tabs mb-0" id="analysisTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="personas-tab" data-bs-toggle="tab" data-bs-target="#personas" 
                            type="button" role="tab" aria-controls="personas" aria-selected="true">
                        <i class="bi bi-people me-2"></i>Persona Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" 
                            type="button" role="tab" aria-controls="recommendations" aria-selected="false">
                        <i class="bi bi-bar-chart-fill me-2"></i>Recommendations Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="conversations-tab" data-bs-toggle="tab" data-bs-target="#conversations" 
                            type="button" role="tab" aria-controls="conversations" aria-selected="false">
                        <i class="bi bi-chat me-2"></i>Conversations
                    </button>
                </li>
                <!-- Add new tab after the existing tabs in the tab list -->
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="debug-insights-tab" data-bs-toggle="tab" data-bs-target="#debug-insights" 
                            type="button" role="tab" aria-controls="debug-insights" aria-selected="false">
                        <i class="bi bi-bug me-2"></i>Debug Insights
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="analysisTabContent">
                <!-- Persona Analysis Tab -->
                <div class="tab-pane fade show active print-section" id="personas" role="tabpanel" aria-labelledby="personas-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">Recommendation Accuracy</div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="accuracy-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">Accuracy Distribution</div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="accuracy-distribution-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendations Analysis Tab -->
                <div class="tab-pane fade print-section" id="recommendations" role="tabpanel" aria-labelledby="recommendations-tab">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">Recommendation Statistics</div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3"><strong>Avg. Precision:</strong></div>
                                        <div class="progress flex-grow-1" style="height: 20px">
                                            <div id="avg-precision-bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3"><strong>Avg. Recall:</strong></div>
                                        <div class="progress flex-grow-1" style="height: 20px">
                                            <div id="avg-recall-bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3"><strong>Avg. Accuracy:</strong></div>
                                        <div class="progress flex-grow-1" style="height: 20px">
                                            <div id="avg-accuracy-bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">Recommendation Counts</div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="recommendation-count-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">Metrics Distribution</div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="metrics-distribution-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">Detailed Recommendations Comparison</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered table-sm" id="recommendations-comparison-table" style="width: 100%;">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 5%;">#</th>
                                            <th style="width: 8%;">Persona</th>
                                            <th style="width: 17%;">Request</th>
                                            <th style="width: 30%;">Expected</th>
                                            <th style="width: 30%;">Actual</th>
                                            <th style="width: 10%;">Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Conversations Tab -->
                <div class="tab-pane fade" id="conversations" role="tabpanel" aria-labelledby="conversations-tab">
                    <div class="conversation-filter-container mb-3">
                        <div class="row conversation-filter-row">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" id="conversation-search" class="form-control" placeholder="Search requests...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select id="persona-filter" class="form-select">
                                    <option value="">All Personas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select id="accuracy-filter" class="form-select">
                                    <option value="">All Accuracy</option>
                                    <option value="high">High (≥75%)</option>
                                    <option value="medium">Medium (50-74%)</option>
                                    <option value="low">Low (<50%)</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button id="reset-filters" class="btn btn-outline-secondary w-100">Reset</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <span class="badge bg-primary me-1" id="conversations-count">0</span> conversation(s) found
                            </div>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div><i class="bi bi-list-ul me-2"></i>Conversations List</div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="time-sort-toggle">
                                        <label class="form-check-label" for="time-sort-toggle">Sort by Time</label>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush conversations-list sticky-list" id="conversations-list">
                                        <!-- Conversations will be added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <!-- Selected Conversation -->
                            <div class="card h-100 d-none" id="conversation-details">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <span id="conversation-title">Conversation Details</span>
                                        <span id="persona-badge" class="badge bg-info ms-2"></span>
                                    </div>
                                    <div>
                                        <div class="form-check form-switch d-inline-block me-3">
                                            <input class="form-check-input" type="checkbox" id="debug-toggle">
                                            <label class="form-check-label" for="debug-toggle">Show Debug Messages</label>
                                        </div>
                                        <button id="export-conversation" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download me-1"></i>Export
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="conversation-header">
                                        <div class="conversation-metrics mb-3">
                                            <div class="metric-pill"><i class="bi bi-clock"></i> <span id="conv-time-to-first">-</span></div>
                                            <div class="metric-pill"><i class="bi bi-hourglass"></i> <span id="conv-time-to-rec">-</span></div>
                                            <div class="metric-pill"><i class="bi bi-calendar3"></i> <span id="conv-date">-</span></div>
                                            <div class="metric-pill"><i class="bi bi-chat-dots"></i> <span id="conv-message-count">-</span></div>
                                        </div>

                                        <div id="conversation-persona-details">
                                            <!-- Persona details will be shown here -->
                                        </div>
                                    </div>
                                    
                                    <div id="restaurant-matches" class="mb-3 d-none">
                                        <h6>Restaurant Matches Analysis</h6>
                                        <div id="restaurant-matches-container">
                                            <!-- Restaurant matches will be shown here -->
                                        </div>
                                    </div>
                                    
                                    <div id="conversation-container" class="conversation-container">
                                        <!-- Messages will be added here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Placeholder when no conversation is selected -->
                            <div class="card h-100" id="no-conversation-placeholder">
                                <div class="card-body d-flex flex-column align-items-center justify-content-center text-center text-muted">
                                    <i class="bi bi-chat-square-text mb-3" style="font-size: 3rem;"></i>
                                    <h5>Select a conversation from the list</h5>
                                    <p>Conversation details will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Add new tab content after the existing tab contents -->
                <div class="tab-pane fade print-section" id="debug-insights" role="tabpanel" aria-labelledby="debug-insights-tab">
                    <!-- Global Debug Insights Section -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up me-2"></i>Global Debug Insights</h5>
                            <p class="text-muted">Explore insights extracted from debug data across all conversations</p>
                        </div>
                    </div>
                    
                    <!-- Stats Summary -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="summary-icon">
                                        <i class="bi bi-tags"></i>
                                    </div>
                                    <div class="summary-title">CATEGORIES</div>
                                    <div class="summary-value" id="debug-category-count">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="summary-icon">
                                        <i class="bi bi-grid-3x3"></i>
                                    </div>
                                    <div class="summary-title">CONCEPTS</div>
                                    <div class="summary-value" id="debug-concept-count">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="summary-icon">
                                        <i class="bi bi-cup-hot"></i>
                                    </div>
                                    <div class="summary-title">RESTAURANTS</div>
                                    <div class="summary-value" id="debug-restaurant-count">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="summary-icon">
                                        <i class="bi bi-rocket"></i>
                                    </div>
                                    <div class="summary-title">ASSOCIATIONS</div>
                                    <div class="summary-value" id="debug-association-count">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Category Analysis -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div><i class="bi bi-tags me-2"></i>Top Categories</div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="category-distribution-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div><i class="bi bi-grid-3x3 me-2"></i>Top Concepts</div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="concept-distribution-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network & Relationship Section -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="bi bi-diagram-3 me-2"></i>Concept Network
                                </div>
                                <div class="card-body">
                                    <div id="concept-network-container" style="height: 400px;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="bi bi-graph-up me-2"></i>Top Concept-Restaurant Associations
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-sm table-hover" id="concept-restaurant-table">
                                            <thead>
                                                <tr>
                                                    <th>Category</th>
                                                    <th>Concept</th>
                                                    <th>Restaurant</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Associations will be added here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Restaurant Analysis Section -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="bi bi-cup-hot me-2"></i>Top Restaurants
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="restaurant-distribution-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="bi bi-tags me-2"></i>Categories & Their Top Restaurants
                                </div>
                                <div class="card-body">
                                    <div class="accordion" id="categoryRestaurantAccordion">
                                        <!-- Category-restaurant items will be added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conversation-level Debug Analysis -->
                    <div class="row mb-3 mt-4">
                        <div class="col-12">
                            <h5><i class="bi bi-chat-right-text me-2"></i>Conversation-level Debug Analysis</h5>
                            <p class="text-muted">Select a conversation to view its debug analysis</p>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-list-ul me-2"></i>Select Conversation
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush" id="debug-conversation-list">
                                        <!-- Conversations will be added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card d-none" id="debug-conversation-details">
                                <div class="card-header">
                                    <i class="bi bi-bug me-2"></i><span id="debug-conversation-title">Conversation Details</span>
                                </div>
                                <div class="card-body">
                                    <div id="debug-conversation-request" class="mb-3"></div>
                                    
                                    <h6 class="mb-3">Debug Sequence Analysis</h6>
                                    
                                    <!-- Initial Concepts Section -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <i class="bi bi-1-circle me-2"></i>Initial Concepts
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="chart-container" style="height: 150px;">
                                                        <canvas id="debug-initial-categories-chart"></canvas>
                                                    </div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="table-responsive" style="max-height: 150px; overflow-y: auto;">
                                                        <table class="table table-sm" id="debug-initial-concepts-table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Category</th>
                                                                    <th>Concept</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <!-- Concepts will be added here -->
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Context Refinement Section -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <i class="bi bi-2-circle me-2"></i>Context Refinement
                                        </div>
                                        <div class="card-body">
                                            <div id="debug-context-container">
                                                <!-- Context details will be added here -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Candidate Restaurants Section -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <i class="bi bi-3-circle me-2"></i>Candidate Restaurants
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-7">
                                                    <div class="chart-container" style="height: 180px;">
                                                        <canvas id="debug-candidate-distribution-chart"></canvas>
                                                    </div>
                                                </div>
                                                <div class="col-md-5">
                                                    <div class="chart-container" style="height: 180px;">
                                                        <canvas id="debug-candidate-scores-chart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <h6 class="mb-2">Top Candidates by Score</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover" id="debug-top-candidates-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Category</th>
                                                            <th>Restaurant</th>
                                                            <th>Score</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Top candidates will be added here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Placeholder when no conversation is selected -->
                            <div class="card" id="debug-no-conversation-placeholder">
                                <div class="card-body d-flex flex-column align-items-center justify-content-center text-center text-muted">
                                    <i class="bi bi-bug mb-3" style="font-size: 3rem;"></i>
                                    <h5>Select a conversation to view debug analysis</h5>
                                    <p>Debug details will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('upload-form');
            const loadingIndicator = document.getElementById('loading');
            const resultsContainer = document.getElementById('results-container');
            const conversationsList = document.getElementById('conversations-list');
            const conversationDetails = document.getElementById('conversation-details');
            const conversationContainer = document.getElementById('conversation-container');
            const conversationTitle = document.getElementById('conversation-title');
            const conversationPersonaDetails = document.getElementById('conversation-persona-details');
            const personaBadge = document.getElementById('persona-badge');
            const exportPdfBtn = document.getElementById('export-pdf');
            const exportPdfMobileBtn = document.getElementById('export-pdf-mobile');
            const debugToggle = document.getElementById('debug-toggle');

            let accuracyChart = null;
            let accuracyDistChart = null;
            let recommendationCountChart = null;
            let metricsDistributionChart = null;
            let responseTimeChart = null;
            
            // Get the Flask server URL - adjust this to your server's address and port
            const FLASK_SERVER_URL = 'http://localhost:5000';
            
            uploadForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(uploadForm);
                const chatFile = document.getElementById('chat-file').files[0];
                
                if (!chatFile) {
                    alert('Please select a file to upload');
                    return;
                }
                
                // Show loading indicator
                loadingIndicator.classList.remove('d-none');
                resultsContainer.classList.add('d-none');
                
                // Upload file - using the full URL with the Flask server address
                fetch(`${FLASK_SERVER_URL}/upload`, {
                    method: 'POST',
                    body: formData,
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        if (response.status === 405) {
                            throw new Error('Method not allowed. The server doesn\'t accept POST requests at this endpoint.');
                        } else {
                            return response.json().then(errorData => {
                                throw new Error(`Server error: ${errorData.error || response.statusText}`);
                            }).catch(err => {
                                // If JSON parsing fails, throw original error
                                if (err.name === 'SyntaxError') {
                                    throw new Error(`Server error: ${response.statusText}`);
                                }
                                throw err;
                            });
                        }
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Upload response:', data);
                    
                    // Store the data globally for later PDF export
                    window.lastUploadedData = data;
                    
                    displayResults(data);
                    
                    // Show export PDF button
                    exportPdfBtn.classList.remove('d-none');
                })
                .catch(error => {
                    console.error('Error uploading file:', error);
                    alert('Error uploading file: ' + error.message);
                })
                .finally(() => {
                    loadingIndicator.classList.add('d-none');
                });
            });
            
            function displayResults(data) {
                // Show results container
                resultsContainer.classList.remove('d-none');
                
                console.log("Received data:", data);  // Debug log to see what data is received
                
                // Update summary stats
                document.getElementById('conversation-count').textContent = data.conversation_count;
                
                // Calculate average time metrics
                let avgRecommendationTime = 0;
                let recommendationTimeCount = 0;
                let avgFirstResponseTime = 0;
                let firstResponseTimeCount = 0;
                
                // Track min/max values
                let minFirstResponse = Infinity;
                let maxFirstResponse = 0;
                let minRecommendationTime = Infinity;
                let maxRecommendationTime = 0;
                
                // Define reasonable maximum time limit (5 minutes in seconds)
                // This prevents extreme outliers from distorting the analysis
                const MAX_REASONABLE_TIME = 300; 
                
                // Array to store filtered response times for chart display
                const filteredMetrics = data.metrics.filter(metric => {
                    // Only include metrics with reasonable response times
                    const validRecommendationTime = metric.time_to_recommendation && 
                                                  metric.time_to_recommendation <= MAX_REASONABLE_TIME;
                                                  
                    const validFirstResponseTime = metric.time_to_first_response && 
                                                 metric.time_to_first_response <= MAX_REASONABLE_TIME;
                                                 
                    return validRecommendationTime || validFirstResponseTime;
                });
                
                // Process response time metrics
                data.metrics.forEach(metric => {
                    if (metric.time_to_recommendation) {
                        // Only include reasonable values in averages
                        if (metric.time_to_recommendation <= MAX_REASONABLE_TIME) {
                            avgRecommendationTime += metric.time_to_recommendation;
                            recommendationTimeCount++;
                            
                            minRecommendationTime = Math.min(minRecommendationTime, metric.time_to_recommendation);
                            maxRecommendationTime = Math.max(maxRecommendationTime, metric.time_to_recommendation);
                        }
                    }
                    
                    if (metric.time_to_first_response) {
                        // Only include reasonable values in averages
                        if (metric.time_to_first_response <= MAX_REASONABLE_TIME) {
                            avgFirstResponseTime += metric.time_to_first_response;
                            firstResponseTimeCount++;
                            
                            minFirstResponse = Math.min(minFirstResponse, metric.time_to_first_response);
                            maxFirstResponse = Math.max(maxFirstResponse, metric.time_to_first_response);
                        }
                    }
                });
                
                // Calculate and display averages
                if (recommendationTimeCount > 0) {
                    avgRecommendationTime = avgRecommendationTime / recommendationTimeCount;
                    document.getElementById('avg-recommendation-time').textContent = avgRecommendationTime.toFixed(1) + 's';
                }
                
                if (firstResponseTimeCount > 0) {
                    avgFirstResponseTime = avgFirstResponseTime / firstResponseTimeCount;
                    document.getElementById('avg-first-response').textContent = avgFirstResponseTime.toFixed(1) + 's';
                }
                
                // Display min/max values
                if (minFirstResponse !== Infinity) {
                    document.getElementById('min-first-response').textContent = `Min: ${minFirstResponse.toFixed(1)}s`;
                    document.getElementById('max-first-response').textContent = `Max: ${maxFirstResponse.toFixed(1)}s`;
                }
                
                if (minRecommendationTime !== Infinity) {
                    document.getElementById('min-recommendation-time').textContent = `Min: ${minRecommendationTime.toFixed(1)}s`;
                    document.getElementById('max-recommendation-time').textContent = `Max: ${maxRecommendationTime.toFixed(1)}s`;
                }
                
                // Display response time chart using filtered metrics
                console.log("Response time metrics (filtered):", filteredMetrics);
                displayResponseTimeChart(filteredMetrics);
                
                // Update persona stats
                if (data.persona_summary) {
                    document.getElementById('matched-personas').textContent = 
                        `${data.persona_summary.matched_conversations}/${data.conversation_count}`;
                    
                    // Create accuracy chart - Add logging to debug data
                    console.log("Metrics for accuracy chart:", data.metrics.filter(m => 'recommendation_accuracy' in m));
                    displayAccuracyChart(data.metrics);
                    
                    // Create accuracy distribution chart - Add logging
                    console.log("Accuracy distribution:", data.persona_summary.accuracy_distribution);
                    displayAccuracyDistributionChart(data.persona_summary.accuracy_distribution);
                    
                    // Update detailed recommendation analysis
                    displayRecommendationAnalysis(data);
                }
                
                // Display conversation list
                displayConversationsList(data.metrics, data.recommendations);
                
                // Initialize debug insights when data is loaded
                initializeDebugInsights(data);

                // Show first tab by default
                const firstTabButton = document.querySelector('#analysisTab button:first-child');
                if (firstTabButton) {
                    firstTabButton.click();
                }
            }
            
            function displayResponseTimeChart(metrics) {
                // Ensure we have data to display
                if (!metrics || metrics.length === 0) {
                    console.warn("No metrics data available for response time chart");
                    return;
                }
                
                // Prepare data for the chart
                const conversationIds = [];
                const firstResponseTimes = [];
                const recommendationTimes = [];
                
                metrics.forEach(metric => {
                    conversationIds.push(`Conv. ${metric.conversation_id + 1}`);
                    firstResponseTimes.push(metric.time_to_first_response || 0);
                    recommendationTimes.push(metric.time_to_recommendation || 0);
                });
                
                console.log("Response time chart data:", { 
                    labels: conversationIds, 
                    firstResponseTimes, 
                    recommendationTimes 
                });
                
                // Create the chart
                const ctx = document.getElementById('response-time-chart').getContext('2d');
                
                if (responseTimeChart) {
                    responseTimeChart.destroy();
                }
                
                responseTimeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: conversationIds,
                        datasets: [
                            {
                                label: 'Time to First Response (s)',
                                data: firstResponseTimes,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Time to Recommendation (s)',
                                data: recommendationTimes,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Time (seconds)'
                                },
                                // Add suggested max to prevent extreme values from making the chart unreadable
                                suggestedMax: Math.min(
                                    Math.max(...firstResponseTimes, ...recommendationTimes) * 1.1, 
                                    60 // Cap at 60 seconds for better readability
                                )
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Conversation'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw.toFixed(1)}s`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function displayAccuracyChart(metrics) {
                // Prepare data for the chart
                const conversationIds = [];
                const accuracyValues = [];
                const backgroundColors = [];
                
                metrics.forEach(metric => {
                    if ('recommendation_accuracy' in metric) {
                        conversationIds.push(`Conv. ${metric.conversation_id + 1}`);
                        const accuracy = metric.recommendation_accuracy * 100;
                        accuracyValues.push(accuracy);
                        
                        // Set color based on accuracy
                        if (accuracy >= 75) {
                            backgroundColors.push('rgba(40, 167, 69, 0.6)');
                        } else if (accuracy >= 50) {
                            backgroundColors.push('rgba(255, 193, 7, 0.6)');
                        } else {
                            backgroundColors.push('rgba(220, 53, 69, 0.6)');
                        }
                    }
                });
                
                // Create the chart
                const ctx = document.getElementById('accuracy-chart').getContext('2d');
                
                if (accuracyChart) {
                    accuracyChart.destroy();
                }
                
                accuracyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: conversationIds,
                        datasets: [{
                            label: 'Accuracy (%)',
                            data: accuracyValues,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(color => color.replace('0.6', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Accuracy (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Conversation'
                                }
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Accuracy: ${context.raw.toFixed(1)}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function displayAccuracyDistributionChart(distribution) {
                // Prepare data for the chart
                const labels = Object.keys(distribution);
                const values = Object.values(distribution);
                
                // Create the chart
                const ctx = document.getElementById('accuracy-distribution-chart').getContext('2d');
                
                if (accuracyDistChart) {
                    accuracyDistChart.destroy();
                }
                
                accuracyDistChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                'rgba(220, 53, 69, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(23, 162, 184, 0.7)'
                            ],
                            borderColor: [
                                'rgba(220, 53, 69, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(40, 167, 69, 1)',
                                'rgba(23, 162, 184, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 15,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function displayRecommendationAnalysis(data) {
                // Update recommendation stats
                const avgPrecision = data.persona_summary.avg_precision * 100;
                const avgRecall = data.persona_summary.avg_recall * 100;
                const avgAccuracy = data.persona_summary.avg_accuracy * 100;
                
                const precisionBar = document.getElementById('avg-precision-bar');
                const recallBar = document.getElementById('avg-recall-bar');
                const accuracyBar = document.getElementById('avg-accuracy-bar');
                
                precisionBar.style.width = `${avgPrecision}%`;
                precisionBar.textContent = `${avgPrecision.toFixed(1)}%`;
                recallBar.style.width = `${avgRecall}%`;
                recallBar.textContent = `${avgRecall.toFixed(1)}%`;
                accuracyBar.style.width = `${avgAccuracy}%`;
                accuracyBar.textContent = `${avgAccuracy.toFixed(1)}%`;
                
                // Create recommendation count chart
                displayRecommendationCountChart(data.persona_summary.recommendation_counts);
                
                // Create metrics distribution chart
                displayMetricsDistributionChart(data.metrics);
                
                // Update comparison table
                const tableBody = document.querySelector('#recommendations-comparison-table tbody');
                tableBody.innerHTML = '';
                
                data.recommendations.forEach(rec => {
                    if (!rec.expected_restaurants) return;
                    
                    const row = document.createElement('tr');
                    
                    // Create cell for conversation ID
                    const idCell = document.createElement('td');
                    idCell.className = 'text-center';
                    idCell.innerHTML = `<span class="badge bg-primary">${rec.conversation_id + 1}</span>`;
                    row.appendChild(idCell);
                    
                    // Create cell for persona ID
                    const personaCell = document.createElement('td');
                    personaCell.className = 'text-center small text-nowrap';
                    if (rec.persona_id) {
                        personaCell.innerHTML = `<span class="badge bg-info" 
                            title="${rec.persona_description || 'No description'}">${rec.persona_id}</span>`;
                    } else {
                        personaCell.innerHTML = '<span class="badge bg-secondary">N/A</span>';
                    }
                    row.appendChild(personaCell);
                    
                    // Create cell for request
                    const requestCell = document.createElement('td');
                    requestCell.className = 'small text-wrap';
                    requestCell.style.fontSize = '0.8rem';
                    requestCell.style.maxWidth = '150px';
                    requestCell.title = rec.request; // Add tooltip with full text
                    
                    // Truncate request text if too long
                    const maxLength = 50;
                    const displayText = rec.request.length > maxLength ? 
                        rec.request.substring(0, maxLength) + '...' : rec.request;
                    requestCell.textContent = displayText;
                    row.appendChild(requestCell);
                    
                    // Create cell for expected recommendations
                    const expectedCell = document.createElement('td');
                    expectedCell.className = 'text-wrap';
                    expectedCell.style.fontSize = '0.8rem';
                    
                    // Create badges for expected recommendations - more compact
                    const badgeHtml = rec.expected_restaurants.map(r => {
                        const isFound = rec.potential_restaurants.some(a => 
                            isSameRestaurant(r, a)
                        );
                        const badgeClass = isFound ? 'bg-success' : 'bg-secondary';
                        // Extract first words to keep badges smaller
                        const displayText = r.split(' ').slice(0, 3).join(' ');
                        return `<span class="badge ${badgeClass} me-1 mb-1 d-inline-block" title="${r}">${displayText}</span>`;
                    }).join('');
                    
                    expectedCell.innerHTML = `
                        <div class="d-flex flex-wrap">
                            ${badgeHtml}
                        </div>
                        <div class="small text-muted" style="font-size: 0.75rem">Total: ${rec.expected_restaurants.length}</div>
                    `;
                    row.appendChild(expectedCell);
                    
                    // Create cell for actual recommendations - more compact
                    const actualCell = document.createElement('td');
                    actualCell.className = 'text-wrap';
                    actualCell.style.fontSize = '0.8rem';
                    
                    // Create badges for actual recommendations - more compact
                    const actualBadges = rec.potential_restaurants.map((r, i) => {
                        const isMatch = rec.expected_restaurants.some(exp => 
                            isSameRestaurant(exp, r)
                        );
                        const bgClass = isMatch ? 'bg-success' : 'bg-danger';
                        // Extract first words to keep badges smaller
                        const displayText = r.split(' ').slice(0, 3).join(' ');
                        return `<span class="badge ${bgClass} me-1 mb-1 d-inline-block" title="${r}">${i+1}. ${displayText}</span>`;
                    }).join('');
                    
                    actualCell.innerHTML = `
                        <div class="d-flex flex-wrap">
                            ${actualBadges}
                        </div>
                    `;
                    row.appendChild(actualCell);
                    
                    // Create cell for score and actions
                    const scoreCell = document.createElement('td');
                    scoreCell.className = 'text-center align-middle';
                    
                    const accuracy = (rec.accuracy * 100).toFixed(0);
                    let scoreClass = 'danger';
                    if (accuracy >= 75) scoreClass = 'success';
                    else if (accuracy >= 50) scoreClass = 'warning';
                    
                    // Create tooltip for metrics
                    const metricsTooltip = `
                        Accuracy: ${accuracy}%<br>
                        Precision: ${(rec.accuracy * rec.expected_restaurants.length / rec.potential_restaurants.length * 100).toFixed(0)}%<br>
                        Found: ${rec.potential_restaurants.filter(r => 
                            rec.expected_restaurants.some(exp => 
                                exp.toLowerCase().includes(r.toLowerCase()) || 
                                r.toLowerCase().includes(exp.toLowerCase())
                            )
                        ).length}/${rec.expected_restaurants.length}
                    `;
                    
                    // Add score pill with details button
                    scoreCell.innerHTML = `
                        <div class="d-flex flex-column align-items-center">
                            <div class="mb-1">
                                <span class="badge bg-${scoreClass} p-2">${accuracy}%</span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-primary view-conv-btn" 
                                    data-conversation-id="${rec.conversation_id}"
                                    data-bs-toggle="tooltip" title="View conversation">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    row.appendChild(scoreCell);
                    
                    // Add the row to the table
                    tableBody.appendChild(row);
                });
                
                // Initialize filter DOM elements
                const resetFiltersBtn = document.getElementById('reset-filters');
                const timeSortToggle = document.getElementById('time-sort-toggle');
                const searchInput = document.getElementById('conversation-search');
                const personaFilter = document.getElementById('persona-filter');
                const accuracyFilter = document.getElementById('accuracy-filter');
                
                // Function to apply filters
                function applyFilters() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const selectedPersona = personaFilter.value;
                    const selectedAccuracy = accuracyFilter.value;
                    
                    let visibleCount = 0;
                    
                    // Filter conversation items
                    document.querySelectorAll('#conversations-list a').forEach(item => {
                        // Check search term
                        const matchesSearch = !searchTerm || 
                                             item.dataset.request && item.dataset.request.includes(searchTerm);
                        
                        // Check persona filter
                        const matchesPersona = !selectedPersona || 
                                             item.dataset.personaId === selectedPersona;
                        
                        // Check accuracy filter
                        const matchesAccuracy = !selectedAccuracy || 
                                              item.dataset.accuracyLevel === selectedAccuracy;
                        
                        // Show/hide based on filter matches
                        if (matchesSearch && matchesPersona && matchesAccuracy) {
                            item.classList.remove('d-none');
                            visibleCount++;
                        } else {
                            item.classList.add('d-none');
                        }
                    });
                    
                    // Update count
                    document.getElementById('conversations-count').textContent = visibleCount;
                }
                
                // Add event listeners
                searchInput.addEventListener('input', applyFilters);
                personaFilter.addEventListener('change', applyFilters);
                accuracyFilter.addEventListener('change', applyFilters);
                
                // Reset filters
                resetFiltersBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    personaFilter.selectedIndex = 0;
                    accuracyFilter.selectedIndex = 0;
                    applyFilters();
                });
                
                // Sort by response time
                timeSortToggle.addEventListener('change', function() {
                    const listItems = Array.from(document.querySelectorAll('#conversations-list a'));
                    const sortedItems = listItems.sort((a, b) => {
                        if (timeSortToggle.checked) {
                            return (parseFloat(a.dataset.responseTime) || 999) - (parseFloat(b.dataset.responseTime) || 999);
                        } else {
                            return parseInt(a.dataset.conversationId) - parseInt(b.dataset.conversationId);
                        }
                    });
                    
                    // Re-append in sorted order
                    const parentList = document.getElementById('conversations-list');
                    parentList.innerHTML = '';
                    sortedItems.forEach(item => parentList.appendChild(item));
                });
            }

            function displayRecommendationCountChart(recommendationCounts) {
                // Convert object to arrays for Chart.js
                const labels = Object.keys(recommendationCounts).map(count => `${count} Restaurant${count === '1' ? '' : 's'}`);
                const values = Object.values(recommendationCounts);
                
                const ctx = document.getElementById('recommendation-count-chart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (recommendationCountChart) {
                    recommendationCountChart.destroy();
                }
                
                recommendationCountChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Number of Conversations',
                            data: values,
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Frequency'
                                },
                                ticks: {
                                    precision: 0
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Number of Restaurants Recommended'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Recommendation Count Distribution'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.raw} conversation${context.raw === 1 ? '' : 's'}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function displayMetricsDistributionChart(metrics) {
                // Extract metrics for conversations with recommendation evaluations
                const evaluatedMetrics = metrics.filter(m => 'recommendation_accuracy' in m);
                
                // Group metrics into ranges
                const ranges = {
                    '0-25%': { precision: 0, recall: 0, accuracy: 0 },
                    '26-50%': { precision: 0, recall: 0, accuracy: 0 },
                    '51-75%': { precision: 0, recall: 0, accuracy: 0 },
                    '76-100%': { precision: 0, recall: 0, accuracy: 0 }
                };
                
                // Calculate ranges based on accuracy values directly from metrics
                evaluatedMetrics.forEach(metric => {
                    // Get the accuracy value directly from the metrics
                    const accuracy = metric.recommendation_accuracy || 0;
                    
                    // For demo purposes, we'll use the same value for precision and recall
                    // In a real implementation, you would get these from your data
                    const precision = accuracy; // Use accuracy as a fallback
                    const recall = accuracy; // Use accuracy as a fallback
                    
                    // Categorize accuracy
                    if (accuracy <= 0.25) ranges['0-25%'].accuracy++;
                    else if (accuracy <= 0.5) ranges['26-50%'].accuracy++;
                    else if (accuracy <= 0.75) ranges['51-75%'].accuracy++;
                    else ranges['76-100%'].accuracy++;
                    
                    // Categorize precision
                    if (precision <= 0.25) ranges['0-25%'].precision++;
                    else if (precision <= 0.5) ranges['26-50%'].precision++;
                    else if (precision <= 0.75) ranges['51-75%'].precision++;
                    else ranges['76-100%'].precision++;
                    
                    // Categorize recall
                    if (recall <= 0.25) ranges['0-25%'].recall++;
                    else if (recall <= 0.5) ranges['26-50%'].recall++;
                    else if (recall <= 0.75) ranges['51-75%'].recall++;
                    else ranges['76-100%'].recall++;
                });
                
                // Prepare data for chart
                const labels = Object.keys(ranges);
                const accuracyData = labels.map(label => ranges[label].accuracy);
                const precisionData = labels.map(label => ranges[label].precision);
                const recallData = labels.map(label => ranges[label].recall);
                
                const ctx = document.getElementById('metrics-distribution-chart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (metricsDistributionChart) {
                    metricsDistributionChart.destroy();
                }
                
                metricsDistributionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Accuracy',
                                data: accuracyData,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Precision',
                                data: precisionData,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Recall',
                                data: recallData,
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Conversation Count'
                                },
                                ticks: {
                                    precision: 0
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Score Range'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Metrics Distribution'
                            }
                        }
                    }
                });
            }

            function loadConversation(conversationId) {
                // Fetch conversation details
                fetch(`${FLASK_SERVER_URL}/conversation/${conversationId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load conversation');
                        }
                        return response.json();
                    })
                    .then(conversation => {
                        // Reset debug toggle to default state (off)
                        debugToggle.checked = false;
                        conversationContainer.classList.add('hide-debug');
                        
                        displayConversation(conversation, conversationId);
                    })
                    .catch(error => {
                        console.error('Error loading conversation:', error);
                    });
            }
            
            // PDF Export functionality
            exportPdfBtn.addEventListener('click', exportPDF);
            exportPdfMobileBtn.addEventListener('click', exportPDF);
            
            // Define the PDF export function
            function exportPDF() {
                // Show loading indicator
                loadingIndicator.classList.remove('d-none');
                
                try {
                    // Safely store data for the PDF export
                    window.metricsData = [];
                    window.personaSummary = {};
                    window.recommendationsData = [];
                    
                    // Access data from the global scope if available
                    if (typeof window.lastUploadedData === 'object' && window.lastUploadedData !== null) {
                        window.metricsData = window.lastUploadedData.metrics || [];
                        window.personaSummary = window.lastUploadedData.persona_summary || {};
                        window.recommendationsData = window.lastUploadedData.recommendations || [];
                    }
                    
                    // Get all active chart instances
                    const activeCharts = [
                        responseTimeChart,
                        accuracyChart, 
                        accuracyDistChart,
                        recommendationCountChart,
                        metricsDistributionChart
                    ].filter(chart => chart !== null);
                    
                    console.log("Active charts for export:", activeCharts.length);
                    
                    // Define chart configurations for the PDF
                    const chartConfigs = [
                        {
                            chartId: 'response-time-chart',
                            title: 'Response Time Analysis'
                        },
                        {
                            chartId: 'accuracy-chart',
                            title: 'Recommendation Accuracy'
                        },
                        {
                            chartId: 'accuracy-distribution-chart',
                            title: 'Accuracy Distribution'
                        },
                        {
                            chartId: 'recommendation-count-chart',
                            title: 'Recommendation Counts'
                        },
                        {
                            chartId: 'metrics-distribution-chart',
                            title: 'Metrics Distribution'
                        }
                    ];
                    
                    // Use the ChartExporter utility to create the PDF
                    ChartExporter.createPDFReport(
                        window.recommendationsData,
                        chartConfigs,
                        function(err) {
                            loadingIndicator.classList.add('d-none');
                            if (err) {
                                alert('There was a problem generating the PDF. Please try again.');
                                console.error('PDF generation error:', err);
                            }
                        }
                    );
                } catch (error) {
                    console.error('Error initiating PDF export:', error);
                    alert('Failed to generate PDF. Please try again or check console for details.');
                    loadingIndicator.classList.add('d-none');
                }
            }
            
            // Move displayConversation inside the DOMContentLoaded scope
            function displayConversation(conversation, conversationId) {
                // Hide placeholder, show details
                document.getElementById('no-conversation-placeholder').classList.add('d-none');
                conversationDetails.classList.remove('d-none');
                
                // Set conversation title
                conversationTitle.textContent = `Conversation ${parseInt(conversationId) + 1}`;
                
                // Clear previous content
                conversationContainer.innerHTML = '';
                conversationPersonaDetails.innerHTML = '';
                
                // Set up debug toggle functionality
                debugToggle.addEventListener('change', function() {
                    if (this.checked) {
                        conversationContainer.classList.remove('hide-debug');
                    } else {
                        conversationContainer.classList.add('hide-debug');
                    }
                });
                
                // Hide debug messages by default
                conversationContainer.classList.add('hide-debug');
                
                // Format and display conversation date
                const firstMsg = conversation[0];
                if (firstMsg && firstMsg.timestamp) {
                    const msgDate = new Date(firstMsg.timestamp);
                    document.getElementById('conv-date').textContent = msgDate.toLocaleDateString();
                }

                // Set message count
                document.getElementById('conv-message-count').textContent = `${conversation.length} messages`;
                
                // Calculate and display time metrics
                let requestTime = null;
                let firstResponseTime = null;
                let recommendationTime = null;

                conversation.forEach(msg => {
                    if (msg.type === 'user_request' && !requestTime) {
                        requestTime = new Date(msg.timestamp);
                    }
                    if (msg.sender !== 'Wagner' && msg.type !== 'debug' && !firstResponseTime) {
                        firstResponseTime = new Date(msg.timestamp);
                    }
                    if (msg.type === 'recommendation' && !recommendationTime) {
                        recommendationTime = new Date(msg.timestamp);
                    }
                });

                if (requestTime && firstResponseTime) {
                    const timeToFirst = (firstResponseTime - requestTime) / 1000;
                    document.getElementById('conv-time-to-first').textContent = `${timeToFirst.toFixed(1)}s to first response`;
                }

                if (requestTime && recommendationTime) {
                    const timeToRec = (recommendationTime - requestTime) / 1000;
                    document.getElementById('conv-time-to-rec').textContent = `${timeToRec.toFixed(1)}s to recommendation`;
                }
                
                // Display persona information if available
                const personaId = firstMsg.persona_id;
                const personaDescription = firstMsg.persona_description;
                
                if (personaId) {
                    personaBadge.textContent = personaId;
                    personaBadge.classList.remove('d-none');
                    
                    if (personaDescription) {
                        // Create persona details section
                        const personaCard = document.createElement('div');
                        personaCard.className = 'card mb-3';
                        
                        personaCard.innerHTML = `
                            <div class="card-header bg-info bg-opacity-10">
                                <i class="bi bi-person me-2"></i>Persona Profile
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>ID:</strong> ${personaId}</p>
                                <p class="mb-2"><strong>Description:</strong> ${personaDescription}</p>
                            </div>
                        `;
                        conversationPersonaDetails.appendChild(personaCard);
                    }
                } else {
                    personaBadge.classList.add('d-none');
                }
                
                // Display messages
                conversation.forEach((msg, index) => {
                    const messageDiv = document.createElement('div');
                    
                    // Determine message class based on type
                    if (msg.type === 'user_request') {
                        messageDiv.className = 'message user';
                    } else if (msg.type === 'debug') {
                        messageDiv.className = 'message debug';
                    } else {
                        messageDiv.className = 'message concierge';
                    }
                    
                    // Format timestamp
                    let formattedTime = '';
                    if (msg.timestamp) {
                        const msgTime = new Date(msg.timestamp);
                        formattedTime = msgTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                    
                    // Create message content
                    let messageContent = `
                        <div class="message-timestamp">${formattedTime}</div>
                        <div class="message-sender">${msg.sender}</div>
                        <div class="message-content">${msg.content.replace(/\n/g, '<br>')}</div>
                    `;
                    
                    // Add debug info if available
                    if (msg.type === 'debug' && msg.debug_info) {
                        messageContent += `
                            <div class="mt-2">
                                <strong>Debug Type:</strong> ${msg.debug_info.type}
                            </div>
                        `;
                        
                        // Show the first few items from debug data
                        if (msg.debug_info.data) {
                            let dataPreview = '';
                            
                            if (Array.isArray(msg.debug_info.data)) {
                                dataPreview = msg.debug_info.data.slice(0, 3).join(', ');
                                if (msg.debug_info.data.length > 3) {
                                    dataPreview += ` ...and ${msg.debug_info.data.length - 3} more`;
                                }
                            } else if (typeof msg.debug_info.data === 'object') {
                                const keys = Object.keys(msg.debug_info.data);
                                dataPreview = keys.slice(0, 3).join(', ');
                                if (keys.length > 3) {
                                    dataPreview += ` ...and ${keys.length - 3} more keys`;
                                }
                            }
                            
                            messageContent += `
                                <div>
                                    <strong>Data:</strong> ${dataPreview}
                                </div>
                            `;
                        }
                    }
                    
                    messageDiv.innerHTML = messageContent;
                    conversationContainer.appendChild(messageDiv);
                });
                
                // Add export functionality
                document.getElementById('export-conversation').onclick = function() {
                    exportConversationToText(conversation, conversationId);
                };
            }
            
            // Function to export conversation to text file
            function exportConversationToText(conversation, conversationId) {
                // Format the conversation as text
                let text = `Conversation ${parseInt(conversationId) + 1}\n`;
                text += `=============================\n\n`;
                
                // Add persona info if available
                if (conversation[0].persona_id) {
                    text += `Persona: ${conversation[0].persona_id}\n`;
                    if (conversation[0].persona_description) {
                        text += `Description: ${conversation[0].persona_description}\n`;
                    }
                    text += `\n`;
                }
                
                // Add messages
                conversation.forEach(msg => {
                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : '';
                    text += `${time} - ${msg.sender} (${msg.type}):\n`;
                    text += `${msg.content}\n\n`;
                });
                
                // Add evaluation if available
                conversation.forEach(msg => {
                    if (msg.type === 'recommendation' && msg.recommendation_evaluation) {
                        const eval = msg.recommendation_evaluation;
                        text += `\nRECOMMENDATION EVALUATION:\n`;
                        text += `===========================\n`;
                        text += `Accuracy: ${(eval.accuracy * 100).toFixed(0)}%\n`;
                        text += `Precision: ${(eval.precision * 100).toFixed(0)}%\n`;
                        text += `Recall: ${(eval.recall * 100).toFixed(0)}%\n`;
                        text += `\nEXPECTED RESTAURANTS:\n`;
                        eval.expected_recommendations.forEach((r, i) => {
                            text += `${i+1}. ${r}\n`;
                        });
                        
                        text += `\nACTUAL RECOMMENDATIONS:\n`;
                        eval.actual_recommendations.forEach((r, i) => {
                            text += `${i+1}. ${r}\n`;
                        });
                    }
                });
                
                // Create and trigger download
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `conversation_${parseInt(conversationId) + 1}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // Add this helper function to the script section
            function isSameRestaurant(name1, name2) {
                // Convert to lowercase for case-insensitive comparison
                name1 = name1.toLowerCase().trim();
                name2 = name2.toLowerCase().trim();
                
                // Exact match
                if (name1 === name2) {
                    return true;
                }
                
                // Special case for restaurants with special characters or common words
                // Split into words and check word similarity
                const words1 = new Set(name1.split(/\s+/));
                const words2 = new Set(name2.split(/\s+/));
                
                // Common words in restaurant names that shouldn't determine a match by themselves
                const commonWords = new Set(['the', 'restaurant', 'café', 'cafe', 'bar', 'grill', 'bistro', 'kitchen']);
                
                // Remove common words for comparison
                const filteredWords1 = new Set([...words1].filter(word => !commonWords.has(word)));
                const filteredWords2 = new Set([...words2].filter(word => !commonWords.has(word)));
                
                // Check if they share substantial words
                if (filteredWords1.size > 0 && filteredWords2.size > 0) {
                    const intersection = new Set([...filteredWords1].filter(x => filteredWords2.has(x)));
                    
                    // Only consider a match if they share significant unique words
                    const minSize = Math.min(filteredWords1.size, filteredWords2.size);
                    if (intersection.size >= minSize * 0.8) {
                        // Additional length check to distinguish "Parigi" from "Bistrot Parigi"
                        const shorter = name1.length < name2.length ? name1 : name2;
                        const longer = name2.length > name1.length ? name2 : name1;
                        
                        // If the longer name is significantly longer, it's likely a different restaurant
                        if (longer.length > shorter.length * 1.5) {
                            // Check if shorter name appears as a complete word in longer name
                            const longerWords = longer.split(/\s+/);
                            if (longerWords.includes(shorter) && longerWords.length > 1) {
                                return false;
                            }
                        }
                        
                        return true;
                    }
                }
                
                return false;
            }

            // Debug Insights Functions
            function initializeDebugInsights(data) {
                // Fetch debug analysis data
                fetch(`${FLASK_SERVER_URL}/debug_analysis`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load debug analysis');
                        return response.json();
                    })
                    .then(debugData => {
                        // Display global debug insights
                        displayGlobalDebugInsights(debugData.global_insights);
                        
                        // Display cross-conversation insights
                        displayCrossConversationInsights(debugData.cross_conversation_insights);
                        
                        // Set up conversation list for debug analysis
                        setupDebugConversationList(data);
                    })
                    .catch(error => {
                        console.error('Error loading debug analysis:', error);
                    });
            }
            
            function displayGlobalDebugInsights(insights) {
                // Update stats summary
                document.getElementById('debug-category-count').textContent = insights.category_count;
                document.getElementById('debug-concept-count').textContent = insights.concept_count;
                document.getElementById('debug-restaurant-count').textContent = insights.restaurant_count;
                document.getElementById('debug-association-count').textContent = insights.association_count;
                
                // Display category distribution chart
                displayCategoryDistributionChart(insights);
                
                // Display concept distribution chart
                displayConceptDistributionChart(insights);
                
                // Display restaurant distribution chart
                displayRestaurantDistributionChart(insights);
            }
            
            function displayCrossConversationInsights(crossInsights) {
                // Display concept-restaurant associations
                displayConceptRestaurantAssociations(crossInsights);
                
                // Display category-restaurant accordion
                displayCategoryRestaurantAccordion(crossInsights);
            }
            
            function displayCategoryDistributionChart(insights) {
                const categoryInsight = insights.find(insight => insight.type === 'category_distribution');
                if (!categoryInsight) return;
                
                const categories = categoryInsight.data.categories;
                const labels = categories.map(item => item[0]);
                const values = categories.map(item => item[1]);
                
                const ctx = document.getElementById('category-distribution-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(199, 199, 199, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 10,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Top Categories'
                            }
                        }
                    }
                });
            }
            
            function displayConceptDistributionChart(insights) {
                const conceptInsight = insights.find(insight => insight.type === 'concept_distribution');
                if (!conceptInsight) return;
                
                const concepts = conceptInsight.data.concepts;
                const labels = concepts.map(item => item[0]);
                const values = concepts.map(item => item[1]);
                
                const ctx = document.getElementById('concept-distribution-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Frequency',
                            data: values,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Frequency'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Top Concepts'
                            }
                        }
                    }
                });
            }
            
            function displayRestaurantDistributionChart(insights) {
                const restaurantInsight = insights.find(insight => insight.type === 'restaurant_distribution');
                if (!restaurantInsight) return;
                
                const restaurants = restaurantInsight.data.restaurants;
                const labels = restaurants.map(item => item[0]);
                const values = restaurants.map(item => item[1]);
                
                const ctx = document.getElementById('restaurant-distribution-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Frequency',
                            data: values,
                            backgroundColor: 'rgba(255, 159, 64, 0.6)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Frequency'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Top Restaurants'
                            }
                        }
                    }
                });
            }
            
            function displayConceptRestaurantAssociations(crossInsights) {
                const tableBody = document.querySelector('#concept-restaurant-table tbody');
                tableBody.innerHTML = '';
                
                if (crossInsights && crossInsights.concept_restaurant_associations) {
                    crossInsights.concept_restaurant_associations.forEach(association => {
                        const row = document.createElement('tr');
                        
                        const categoryCell = document.createElement('td');
                        categoryCell.textContent = association.category;
                        row.appendChild(categoryCell);
                        
                        const conceptCell = document.createElement('td');
                        conceptCell.textContent = association.concept;
                        row.appendChild(conceptCell);
                        
                        const restaurantCell = document.createElement('td');
                        restaurantCell.textContent = association.restaurant;
                        row.appendChild(restaurantCell);
                        
                        const countCell = document.createElement('td');
                        countCell.textContent = association.count;
                        row.appendChild(countCell);
                        
                        tableBody.appendChild(row);
                    });
                }
            }
            
            function displayCategoryRestaurantAccordion(crossInsights) {
                const accordion = document.getElementById('categoryRestaurantAccordion');
                accordion.innerHTML = '';
                
                if (crossInsights && crossInsights.category_restaurant_associations) {
                    crossInsights.category_restaurant_associations.forEach((category, index) => {
                        const accordionItem = document.createElement('div');
                        accordionItem.className = 'accordion-item';
                        
                        const headerId = `heading${index}`;
                        const collapseId = `collapse${index}`;
                        
                        accordionItem.innerHTML = `
                            <h2 class="accordion-header" id="${headerId}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                    ${category.category} (${category.top_restaurants.length} restaurants)
                                </button>
                            </h2>
                            <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headerId}"
                                data-bs-parent="#categoryRestaurantAccordion">
                                <div class="accordion-body p-0">
                                    <ul class="list-group list-group-flush">
                                        ${category.top_restaurants.map(r => 
                                            `<li class="list-group-item d-flex justify-content-between align-items-center">
                                                ${r.name}
                                                <span class="badge bg-primary rounded-pill">${r.count}</span>
                                             </li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                        
                        accordion.appendChild(accordionItem);
                    });
                }
            }
            
            function setupDebugConversationList(data) {
                const debugConversationList = document.getElementById('debug-conversation-list');
                debugConversationList.innerHTML = ''; // Clear existing items
                
                // Check if we have the conversations data
                if (!data || (!data.conversations && !data.metrics)) {
                    console.warn("No conversation data available for debug analysis");
                    debugConversationList.innerHTML = '<div class="list-group-item text-muted">No conversations with debug data available</div>';
                    return;
                }
                
                // Use metrics data to create list items since full conversations might not be available
                const metrics = data.metrics || [];
                
                for (let i = 0; i < metrics.length; i++) {
                    const metric = metrics[i];
                    
                    // Create list item for all conversations - we'll fetch debug data on demand
                    const listItem = document.createElement('a');
                    listItem.href = '#';
                    listItem.className = 'list-group-item list-group-item-action';
                    listItem.dataset.conversationId = i;
                    
                    const requestText = metric.request || 'No request';
                    const truncatedRequest = requestText.length > 60 ? requestText.substring(0, 60) + '...' : requestText;
                    
                    listItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Conversation ${i + 1}</h6>
                        </div>
                        <p class="mb-1 text-truncate">${truncatedRequest}</p>
                    `;
                    
                    listItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadDebugConversationAnalysis(i);
                        
                        // Set active state
                        document.querySelectorAll('#debug-conversation-list a').forEach(item => {
                            item.classList.remove('active');
                        });
                        this.classList.add('active');
                    });
                    
                    debugConversationList.appendChild(listItem);
                }
            }
            
            function loadDebugConversationAnalysis(conversationId) {
                // Show loading placeholder or spinner here if needed
                
                fetch(`${FLASK_SERVER_URL}/debug_analysis/${conversationId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load conversation debug analysis');
                        return response.json();
                    })
                    .then(analysis => {
                        displayDebugConversationAnalysis(analysis);
                    })
                    .catch(error => {
                        console.error('Error loading conversation debug analysis:', error);
                    });
            }
            
            function displayDebugConversationAnalysis(analysis) {
                // Show the conversation details panel and hide the placeholder
                document.getElementById('debug-no-conversation-placeholder').classList.add('d-none');
                const detailsPanel = document.getElementById('debug-conversation-details');
                detailsPanel.classList.remove('d-none');
                
                // Set conversation title and request
                document.getElementById('debug-conversation-title').textContent = 
                    `Conversation ${analysis.conversation_id + 1} Debug Analysis`;
                    
                document.getElementById('debug-conversation-request').innerHTML = `
                    <h5 class="card-title">User Request</h5>
                    <p class="card-text">${analysis.request || 'No request available'}</p>
                `;
                
                // Display initial concepts analysis
                displayInitialConceptsAnalysis(analysis.concept_evolution);
                
                // Display context refinement analysis
                displayContextRefinementAnalysis(analysis.concept_evolution);
                
                // Display candidate restaurants analysis
                displayCandidateRestaurantsAnalysis(analysis.concept_evolution);
            }
            
            function displayInitialConceptsAnalysis(conceptEvolution) {
                const metadata = conceptEvolution?.metadata || [];
                
                // Count categories
                const categoryCount = {};
                metadata.forEach(item => {
                    if (!categoryCount[item.category]) {
                        categoryCount[item.category] = 0;
                    }
                    categoryCount[item.category]++;
                });
                
                // Display category distribution chart
                const ctx = document.getElementById('debug-initial-categories-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categoryCount),
                        datasets: [{
                            data: Object.values(categoryCount),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(199, 199, 199, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 10,
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Populate concepts table
                const conceptsTable = document.getElementById('debug-initial-concepts-table').querySelector('tbody');
                conceptsTable.innerHTML = '';
                
                metadata.forEach(concept => {
                    const row = document.createElement('tr');
                    
                    const categoryCell = document.createElement('td');
                    categoryCell.textContent = concept.category;
                    row.appendChild(categoryCell);
                    
                    const conceptCell = document.createElement('td');
                    conceptCell.textContent = concept.value;
                    row.appendChild(conceptCell);
                    
                    conceptsTable.appendChild(row);
                });
            }
            
            function displayContextRefinementAnalysis(conceptEvolution) {
                const context = conceptEvolution?.context || {};
                const contextContainer = document.getElementById('debug-context-container');
                contextContainer.innerHTML = '';
                
                // Check if we have context data
                if (Object.keys(context).length === 0) {
                    contextContainer.innerHTML = '<p class="text-muted">No context refinement data available</p>';
                    return;
                }
                
                // Create a card for each context category
                Object.entries(context).forEach(([category, values]) => {
                    const card = document.createElement('div');
                    card.className = 'card mb-2';
                    
                    let valuesHtml = '';
                    if (Array.isArray(values)) {
                        valuesHtml = `
                            <ul class="list-group list-group-flush">
                                ${values.map(v => `<li class="list-group-item">${v}</li>`).join('')}
                            </ul>
                        `;
                    } else if (typeof values === 'object') {
                        valuesHtml = `
                            <div class="card-body">
                                <pre class="mb-0" style="font-size: 0.8rem;">${JSON.stringify(values, null, 2)}</pre>
                            </div>
                        `;
                    } else {
                        valuesHtml = `
                            <div class="card-body">
                                <p class="mb-0">${values}</p>
                            </div>
                        `;
                    }
                    
                    card.innerHTML = `
                        <div class="card-header bg-light py-1">
                            <strong>${category}</strong>
                        </div>
                        ${valuesHtml}
                    `;
                    
                    contextContainer.appendChild(card);
                });
            }
            
            function displayCandidateRestaurantsAnalysis(conceptEvolution) {
                const candidates = conceptEvolution?.candidates || [];
                
                // Create candidate restaurant distribution chart
                const distributionData = candidates.map(c => ({ 
                    category: c.category, 
                    count: c.restaurants.length 
                }));
                
                const categoryLabels = distributionData.map(d => d.category);
                const categoryValues = distributionData.map(d => d.count);
                
                const distCtx = document.getElementById('debug-candidate-distribution-chart').getContext('2d');
                new Chart(distCtx, {
                    type: 'bar',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            label: 'Restaurant Count',
                            data: categoryValues,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Count'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Category'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Restaurants per Category'
                            }
                        }
                    }
                });
                
                // Create candidate score distribution chart
                const allScores = [];
                candidates.forEach(c => {
                    c.restaurants.forEach(r => {
                        allScores.push(r.score);
                    });
                });
                
                // Group scores into ranges
                const scoreRanges = {
                    '0.0-0.2': 0,
                    '0.2-0.4': 0,
                    '0.4-0.6': 0,
                    '0.6-0.8': 0,
                    '0.8-1.0': 0
                };
                
                allScores.forEach(score => {
                    if (score < 0.2) scoreRanges['0.0-0.2']++;
                    else if (score < 0.4) scoreRanges['0.2-0.4']++;
                    else if (score < 0.6) scoreRanges['0.4-0.6']++;
                    else if (score < 0.8) scoreRanges['0.6-0.8']++;
                    else scoreRanges['0.8-1.0']++;
                });
                
                const scoresCtx = document.getElementById('debug-candidate-scores-chart').getContext('2d');
                new Chart(scoresCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(scoreRanges),
                        datasets: [{
                            data: Object.values(scoreRanges),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(255, 205, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(54, 162, 235, 0.6)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 10,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Score Distribution',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                });
                
                // Populate top candidates table
                const topCandidatesTable = document.getElementById('debug-top-candidates-table').querySelector('tbody');
                topCandidatesTable.innerHTML = '';
                
                // Get all candidates from all categories and sort by score
                const allCandidates = [];
                candidates.forEach(c => {
                    c.restaurants.forEach(r => {
                        allCandidates.push({
                            category: c.category,
                            name: r.name,
                            score: r.score
                        });
                    });
                });
                
                // Sort by score descending and take top 10
                const topCandidates = allCandidates
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10);
                
                // Add to table
                topCandidates.forEach(candidate => {
                    const row = document.createElement('tr');
                    
                    const categoryCell = document.createElement('td');
                    categoryCell.textContent = candidate.category;
                    row.appendChild(categoryCell);
                    
                    const nameCell = document.createElement('td');
                    nameCell.textContent = candidate.name;
                    row.appendChild(nameCell);
                    
                    const scoreCell = document.createElement('td');
                    scoreCell.textContent = candidate.score.toFixed(2);
                    // Add color based on score
                    if (candidate.score >= 0.8) {
                        scoreCell.classList.add('text-success', 'fw-bold');
                    } else if (candidate.score >= 0.6) {
                        scoreCell.classList.add('text-primary');
                    } else if (candidate.score >= 0.4) {
                        scoreCell.classList.add('text-warning');
                    } else {
                        scoreCell.classList.add('text-danger');
                    }
                    row.appendChild(scoreCell);
                    
                    topCandidatesTable.appendChild(row);
                });
            }

            function displayConversationsList(metrics, recommendations) {
                // Clear existing list
                conversationsList.innerHTML = '';
                
                // Get search input, not directly used in this function but referenced by event listeners
                const searchInput = document.getElementById('conversation-search');
                
                // Get persona filter select element
                const personaFilter = document.getElementById('persona-filter');
                personaFilter.innerHTML = '<option value="">All Personas</option>';
                
                // Track all personas for filter
                const personas = new Set();
                
                // Process all metrics to create conversation list
                metrics.forEach(metric => {
                    const conversationId = metric.conversation_id;
                    
                    // Find corresponding recommendation data if available
                    const recommendation = recommendations.find(r => r.conversation_id === conversationId);
                    
                    // Create list item
                    const listItem = document.createElement('a');
                    listItem.href = '#';
                    listItem.className = 'list-group-item list-group-item-action conversation-list-item';
                    
                    // Set various data attributes for filtering
                    listItem.dataset.conversationId = conversationId;
                    listItem.dataset.request = metric.request ? metric.request.toLowerCase() : '';
                    
                    // Add response time data for sorting
                    if (metric.time_to_recommendation) {
                        listItem.dataset.responseTime = metric.time_to_recommendation;
                    } else if (metric.time_to_first_response) {
                        listItem.dataset.responseTime = metric.time_to_first_response;
                    }
                    
                    // Add persona data if available
                    if (metric.persona_id) {
                        listItem.dataset.personaId = metric.persona_id;
                        personas.add(metric.persona_id);
                    }
                    
                    // Determine accuracy level for filtering
                    if ('recommendation_accuracy' in metric) {
                        const accuracy = metric.recommendation_accuracy * 100;
                        if (accuracy >= 75) {
                            listItem.dataset.accuracyLevel = 'high';
                        } else if (accuracy >= 50) {
                            listItem.dataset.accuracyLevel = 'medium';
                        } else {
                            listItem.dataset.accuracyLevel = 'low';
                        }
                    }
                    
                    // Create content for the list item
                    const requestText = metric.request || 'No request';
                    const truncatedRequest = requestText.length > 60 ? requestText.substring(0, 60) + '...' : requestText;
                    
                    // Create accuracy badge if available
                    let accuracyBadge = '';
                    if ('recommendation_accuracy' in metric) {
                        const accuracy = metric.recommendation_accuracy * 100;
                        let badgeClass = 'bg-danger';
                        if (accuracy >= 75) {
                            badgeClass = 'bg-success';
                        } else if (accuracy >= 50) {
                            badgeClass = 'bg-warning';
                        }
                        accuracyBadge = `<span class="badge ${badgeClass} accuracy-badge">${accuracy.toFixed(0)}%</span>`;
                    }
                    
                    // Create persona badge if available
                    let personaBadge = '';
                    if (metric.persona_id) {
                        personaBadge = `<span class="badge bg-info me-1">${metric.persona_id}</span>`;
                    }
                    
                    // Create time badge if available
                    let timeBadge = '';
                    if (metric.time_to_recommendation) {
                        timeBadge = `<span class="badge bg-secondary">${metric.time_to_recommendation.toFixed(1)}s</span>`;
                    }
                    
                    // Set the HTML content
                    listItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="mb-1">Conv. ${conversationId + 1}</strong>
                                ${personaBadge}
                            </div>
                            <div>
                                ${accuracyBadge}
                                ${timeBadge}
                            </div>
                        </div>
                        <p class="mb-1 text-truncate">${truncatedRequest}</p>
                    `;
                    
                    // Add click handler to load conversation details
                    listItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // Remove active class from all items
                        document.querySelectorAll('#conversations-list a').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // Add active class to clicked item
                        this.classList.add('active');
                        
                        // Load conversation details
                        loadConversation(conversationId);
                    });
                    
                    // Add the item to the list
                    conversationsList.appendChild(listItem);
                });
                
                // Update conversation count
                document.getElementById('conversations-count').textContent = metrics.length;
                
                // Build persona filter options
                personas.forEach(persona => {
                    const option = document.createElement('option');
                    option.value = persona;
                    option.textContent = persona;
                    personaFilter.appendChild(option);
                });
                
                // Add click handler for "View Conversation" buttons in the table
                document.querySelectorAll('.view-conv-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const conversationId = parseInt(this.dataset.conversationId);
                        
                        // Switch to conversations tab
                        document.getElementById('conversations-tab').click();
                        
                        // Find and click the corresponding conversation item
                        const listItem = document.querySelector(`#conversations-list a[data-conversation-id="${conversationId}"]`);
                        if (listItem) {
                            listItem.click();
                            // Scroll to the item to ensure it's visible
                            listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
